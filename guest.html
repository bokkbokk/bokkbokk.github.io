<!DOCTYPE html>
<html>
<head>
  <title>GuestBook</title>
  <style>
    body {
      font-family: sans-serif;
    }
    #chat-container {
      width: 500px;
      margin: 0 auto;
      border: 1px solid #ccc;
      padding: 10px;
    }
    #message-list {
      height: 300px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .message {
      margin-bottom: 10px;
    }
    .user-message {
      text-align: right;
    }
    .other-message {
      text-align: left;
    }
    .username {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <h1>Realtime Chat with History</h1>
    <div id="message-list"></div>
    <div>
      <input type="text" id="username" placeholder="Enter your username" />
      <input type="text" id="message" placeholder="Enter message" />
      <button id="send-button">Send</button>
    </div>
  </div>

  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  <script>
    const messageList = document.getElementById('message-list');
    const usernameInput = document.getElementById('username');
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send-button');
    const channel = 'chat_channel';

    // Initialize PubNub
    const pubnub = new PubNub({
      publishKey: 'pub-c-9233a71f-55d9-4a79-8c20-49437dac12d4',
      subscribeKey: 'sub-c-d33fc166-7366-400a-a165-dd78a88ed735',
      //uuid: 'YOUR_UUID' // optional, unique identifier for the user
    });

    // Fetch and display message history
    pubnub.history(
      {
        channel: channel,
        count: 100, // Number of messages to retrieve
        reverse: false // false means the newest messages are retrieved last
      },
      (status, response) => {
        const messages = response.messages;
        messages.forEach(message => {
          const data = message.entry;
          displayMessage(data.username, data.message);
        });
      }
    );

    // Send a message when the Send button is clicked
    sendButton.addEventListener('click', () => {
      const username = usernameInput.value;
      const message = messageInput.value;

      if (message.trim() !== '' && username.trim() !== '') {
        pubnub.publish({
          channel: channel,
          message: { username: username, message: message }
        });
        messageInput.value = '';
      } else {
        alert('Please enter both a username and a message.');
      }
    });

    // Listen for new messages
    pubnub.addListener({
      message: function(event) {
        const data = event.message;
        displayMessage(data.username, data.message);
      }
    });

    // Subscribe to the channel
    pubnub.subscribe({ channels: [channel] });

    // Function to display messages
    function displayMessage(username, message) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('message');
      messageElement.classList.add(username === usernameInput.value ? 'user-message' : 'other-message');
      messageElement.innerHTML = `<span class="username">${username}:</span> ${message}`;
      messageList.appendChild(messageElement);
      messageList.scrollTop = messageList.scrollHeight;
    }
  </script>
</body>
</html>
